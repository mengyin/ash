---
title: "investigate_cdf"
output: html_document
---

```{r}
load("res.RData")
#load("res10.RData")
#res=res10
library("dscr")
library("ashr")
library(reshape2)
library(ggplot2)
library(dplyr)


neglong = 
  res$negprob %>% 
    select(-user.self,-sys.self,-elapsed,-user.child,-sys.child) %>%
    melt(id.vars=c("method","scenario","seed",".id"),value.name="negprob") %>%
    filter(negprob > 0.9)
 
poslong = 
  res$posprob %>% 
    select(-user.self,-sys.self,-elapsed,-user.child,-sys.child) %>%
    melt(id.vars=c("method","scenario","seed",".id"),value.name="posprob") %>%
    filter(posprob > 0.9)

reslong = 
  res$cdf_score %>% 
    select(-user.self,-sys.self,-elapsed,-user.child,-sys.child) %>%    
    melt(id.vars=c("method","scenario","seed",".id"))

reslong.pos = inner_join(reslong,poslong)
reslong.neg = inner_join(reslong,neglong)

```


```{r}

cdfplot=function(df,title=""){
  p=ggplot(df,aes(x=value,color=method)) + stat_ecdf() + facet_grid(.~scenario) + ggtitle(title)
  print(p +coord_equal(ratio = 1)+geom_abline())
  #print(p+coord_cartesian(xlim = c(0,1),ylim=c(0,1)) +coord_equal(ratio = 1))
}
pdf("cdfplots_coverage.pdf")
cdfplot(reslong.pos %>% 
          filter(method %in% c("ash.n","ash.hu","ash.u","ash.hu.s") & scenario %in% c("A","B","C","efron_FCR")), "Positive Discoveries"
        )

cdfplot(reslong.neg %>% 
          filter(method %in% c("ash.n","ash.hu","ash.u","ash.hu.s") & scenario %in% c("A","B","C","efron_FCR")), "Negative Discoveries"
        )

cdfplot(reslong %>% 
          filter(method %in% c("ash.n","ash.hu","ash.u","ash.hu.s") & scenario %in% c("A","B","C","efron_FCR")), "All observations"
        )



dev.off()
```

Table of upper tail for all observations
```{r}
xtabs(ut~method+scenario,reslong %>% group_by(scenario,method) %>% summarize(ut = mean(value>0.95))) %>% round(2)
```

Table of lower tail for all observations
```{r}
xtabs(lt~method+scenario,reslong %>% group_by(scenario,method) %>% summarize(lt = mean(value<0.05))) %>% round(2)
```

Table of 0.90 CI coverage for all observations
```{r}
xtabs(bt~method+scenario,reslong %>% group_by(scenario,method) %>% summarize(bt = mean(value>0.05 & value <0.95))) %>% round(2)
```


This is the table for the upper tail of the negative findings
and lower tail of positive findings. This should generally perform well.
```{r}
xtabs(ut~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(ut = mean(value>0.95))) %>% round(2)

xtabs(lt~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(lt = mean(value<0.05))) %>% round(2)
```

This is the table for the upper tail of the negative findings
and lower tail of positive findings. The uniform methods
tend to over-shrink.
```{r}
xtabs(lt~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(lt = mean(value<0.05))) %>% round(2)


xtabs(ut~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(ut = mean(value>0.95))) %>% round(2)



# > xtabs(lt~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(lt = mean(value<0.05))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.12 0.12 0.07 0.08 0.07 0.07 0.06      0.06 0.13
#   ash.hu.cxx 0.12 0.12 0.07 0.08 0.07 0.07 0.06      0.06 0.13
#   ash.hu.nw2 0.11 0.10 0.08 0.10 0.07 0.07 0.06      0.07 0.13
#   ash.hu.s   0.08 0.08 0.08 0.08 0.06 0.06 0.05      0.05 0.11
#   ash.n      0.06 0.05 0.00 0.00 0.06 0.06 0.05      0.03 0.06
#   ash.n.nw2  0.06 0.05 0.01 0.02 0.07 0.07 0.05      0.03 0.05
#   ash.n.s    0.06 0.05 0.01 0.03 0.07 0.07 0.05      0.04 0.05
#   ash.u      0.10 0.10 0.07 0.07 0.09 0.09 0.05      0.07 0.12
#   ash.u.nw2  0.09 0.09 0.08 0.10 0.09 0.09 0.06      0.07 0.12
#   ash.u.s    0.07 0.07 0.07 0.10 0.09 0.09 0.05      0.07 0.09
# > xtabs(ut~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(ut = mean(value>0.95))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.05 0.07 0.04 0.07 0.05 0.05 0.05      0.05 0.06
#   ash.hu.cxx 0.05 0.07 0.04 0.07 0.05 0.05 0.05      0.05 0.06
#   ash.hu.nw2 0.05 0.06 0.04 0.07 0.05 0.05 0.05      0.05 0.07
#   ash.hu.s   0.06 0.15 0.05 0.16 0.05 0.18 0.19      0.26 0.26
#   ash.n      0.04 0.06 0.04 0.06 0.04 0.04 0.05      0.03 0.05
#   ash.n.nw2  0.04 0.06 0.04 0.06 0.04 0.04 0.05      0.03 0.05
#   ash.n.s    0.05 0.05 0.04 0.05 0.04 0.04 0.05      0.03 0.06
#   ash.u      0.05 0.06 0.04 0.06 0.04 0.04 0.05      0.04 0.06
#   ash.u.nw2  0.04 0.06 0.04 0.06 0.04 0.04 0.05      0.04 0.06
#   ash.u.s    0.05 0.05 0.05 0.05 0.04 0.04 0.05      0.03 0.06
# > xtabs(lt~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(lt = mean(value<0.05))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.05 0.06 0.04 0.04 0.06 0.05 0.05      0.00 0.06
#   ash.hu.cxx 0.05 0.06 0.04 0.04 0.06 0.05 0.05      0.00 0.06
#   ash.hu.nw2 0.05 0.05 0.04 0.04 0.05 0.05 0.05      0.33 0.05
#   ash.hu.s   0.06 0.24 0.06 0.26 0.06 0.25 0.17      0.56 0.42
#   ash.n      0.05 0.05 0.03 0.03 0.09 0.10 0.04      0.34 0.04
#   ash.n.nw2  0.04 0.04 0.04 0.04 0.08 0.09 0.04      0.31 0.04
#   ash.n.s    0.05 0.05 0.04 0.05 0.07 0.08 0.05      0.41 0.05
#   ash.u      0.05 0.06 0.04 0.04 0.10 0.11 0.05      0.33 0.05
#   ash.u.nw2  0.05 0.05 0.04 0.04 0.08 0.09 0.05      0.33 0.04
#   ash.u.s    0.05 0.05 0.05 0.06 0.08 0.08 0.05      0.48 0.06
# > xtabs(ut~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(ut = mean(value>0.95))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.10 0.11 0.06 0.07 0.10 0.12 0.06      0.00 0.17
#   ash.hu.cxx 0.10 0.11 0.06 0.07 0.10 0.12 0.06      0.00 0.17
#   ash.hu.nw2 0.09 0.09 0.07 0.11 0.09 0.11 0.06      0.00 0.17
#   ash.hu.s   0.07 0.07 0.07 0.08 0.08 0.07 0.05      0.00 0.09
#   ash.n      0.05 0.05 0.00 0.00 0.00 0.00 0.05      0.00 0.06
#   ash.n.nw2  0.05 0.06 0.01 0.01 0.01 0.01 0.05      0.00 0.07
#   ash.n.s    0.05 0.05 0.01 0.03 0.01 0.01 0.05      0.00 0.07
#   ash.u      0.09 0.11 0.07 0.08 0.01 0.01 0.06      0.00 0.13
#   ash.u.nw2  0.08 0.09 0.08 0.11 0.01 0.01 0.06      0.00 0.12
#   ash.u.s    0.07 0.07 0.07 0.11 0.01 0.02 0.06      0.00 0.10
# > xtabs(bt~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(bt = mean(value>0.05 & value <0.95))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.83 0.82 0.89 0.85 0.88 0.87 0.89      0.89 0.81
#   ash.hu.cxx 0.83 0.82 0.89 0.85 0.88 0.87 0.89      0.89 0.81
#   ash.hu.nw2 0.85 0.83 0.88 0.84 0.88 0.88 0.89      0.88 0.80
#   ash.hu.s   0.86 0.77 0.87 0.76 0.88 0.76 0.75      0.69 0.63
#   ash.n      0.90 0.89 0.96 0.94 0.90 0.90 0.90      0.94 0.89
#   ash.n.nw2  0.90 0.89 0.95 0.92 0.90 0.90 0.90      0.94 0.90
#   ash.n.s    0.89 0.91 0.94 0.92 0.89 0.90 0.90      0.93 0.89
#   ash.u      0.85 0.84 0.89 0.86 0.87 0.86 0.89      0.89 0.82
#   ash.u.nw2  0.87 0.85 0.88 0.83 0.87 0.87 0.89      0.89 0.82
#   ash.u.s    0.87 0.88 0.88 0.85 0.87 0.88 0.90      0.90 0.85
# > xtabs(bt~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(bt = mean(value>0.05 & value <0.95))) %>% round(2)
#             scenario
# method          A   An    B   Bn    C   Cn easy efron_FCR hard
#   ash.hu     0.84 0.83 0.90 0.89 0.84 0.83 0.89      1.00 0.77
#   ash.hu.cxx 0.84 0.83 0.90 0.89 0.84 0.83 0.89      1.00 0.77
#   ash.hu.nw2 0.86 0.85 0.88 0.85 0.86 0.84 0.89      0.67 0.78
#   ash.hu.s   0.87 0.68 0.87 0.65 0.87 0.67 0.77      0.44 0.49
#   ash.n      0.90 0.90 0.96 0.96 0.91 0.90 0.91      0.66 0.89
#   ash.n.nw2  0.90 0.90 0.95 0.94 0.92 0.91 0.90      0.69 0.89
#   ash.n.s    0.90 0.90 0.94 0.92 0.92 0.91 0.90      0.59 0.88
#   ash.u      0.86 0.84 0.90 0.88 0.89 0.88 0.90      0.67 0.82
#   ash.u.nw2  0.88 0.86 0.88 0.85 0.90 0.90 0.90      0.67 0.83
#   ash.u.s    0.88 0.88 0.87 0.84 0.91 0.90 0.89      0.52 0.84
```

```{r}
# res1 = as.matrix(res1[,5:1004])
# neg = as.matrix(neg[,5:1004])
# pos = as.matrix(pos[,5:1004])
# 
# hist(res1[pos>0.9])
# hist(res1[neg>0.9])
# 
# res_cdf.mix = as.matrix(res$cdf_score[grepl("mixfdr",res$cdf_score$method),5:1004])
# fdr.mix = as.matrix(res$fdr[grepl("mixfdr",res$fdr$method),5:1004])
# 
# hist(res_cdf.mix[fdr.mix<0.1])
# 
# 
# 
# res_ecdf = apply(res_cdf,1,ecdf)
# 
# #plot for scenario A, histogram of cdf values for observations tha are
# #significant, separately for positive and negative findings
# pnhistA=function(method,seed){
#   temp=dscr::loadExample(dsc_shrink,seed,"A",method)
#   neg=(temp$output$NegativeProb>0.9)
#   pos=(temp$output$PositiveProb>0.9)
#   par(mfcol=c(2,1))
#   hist(as.numeric(res_cdf[seed,neg]),nclass=20)
#   hist(as.numeric(res_cdf[seed,pos]),nclass=20)
# }
# 
# plotcdfA=function(method,seed){
#   temp=dscr::loadExample(dsc_shrink,seed,"A",method)
#   par(mfcol=c(1,1))
#   plot(temp$output)
#   g=normalmix(c(2/3,1/3),c(0,0),c(1,2)) # the g for scenario A
#   lines(seq(-5,5,length=100),mixcdf(g,seq(-5,5,length=100)),col=2,lwd=2)
# }
# 
# temp=dscr::loadExample(dsc_shrink,4,"A","ash.n")
# neg = temp$output$NegativeProb>0.9
# pnhistA("ash.n",4)
# plotcdfA("ash.n",4)
# temp=loadExample(dsc_shrink,4,"A","ash.n")
# plot(temp$meta$beta,temp$input$betahat,col=neg+1)

```

Table for both tails - coverage of 0.9 symetric intervals.
```{r}
xtabs(bt~method+scenario,reslong.neg %>% group_by(scenario,method) %>% summarize(bt = mean(value>0.05 & value <0.95))) %>% round(2)
xtabs(bt~method+scenario,reslong.pos %>% group_by(scenario,method) %>% summarize(bt = mean(value>0.05 & value <0.95))) %>% round(2)

```

